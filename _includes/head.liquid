<!-- Metadata, OpenGraph and Schema.org -->
{% include metadata.liquid %}

<!-- Bootstrap & MDB -->
<link rel="stylesheet" href="{{ '/assets/css/bootstrap.min.css' | relative_url | bust_file_cache }}">
<link
  rel="stylesheet"
  href="{{ site.third_party_libraries.mdb.url.css }}"
  integrity="{{ site.third_party_libraries.mdb.integrity.css }}"
  crossorigin="anonymous"
>

{% if page.pretty_table %}
  <!-- Bootstrap Table -->
  <link
    defer
    rel="stylesheet"
    href="{{ site.third_party_libraries.bootstrap-table.url.css }}"
    integrity="{{ site.third_party_libraries.bootstrap-table.integrity.css }}"
    crossorigin="anonymous"
  >
{% endif %}

<!-- Fonts & Icons -->
<link defer rel="stylesheet" href="{{ '/assets/css/academicons.min.css' | relative_url | bust_file_cache }}">
<link defer rel="stylesheet" href="{{ '/assets/css/scholar-icons.css' | relative_url | bust_file_cache }}">
<link
  defer
  rel="stylesheet"
  type="text/css"
  href="{{ site.third_party_libraries.google_fonts.url.fonts }}"
>

<!-- Code Syntax Highlighting -->
<link
  defer
  rel="stylesheet"
  href="{{ '/assets/css/jekyll-pygments-themes-github.css' | relative_url | bust_file_cache }}"
  media=""
  id="highlight_theme_light"
>

{% if page.toc and page.toc.sidebar %}
  <!-- Sidebar Table of Contents -->
  <link defer href="{{ '/assets/css/bootstrap-toc.min.css' | relative_url | bust_file_cache }}" rel="stylesheet">
{% endif %}

<!-- Styles -->

{% if page.pseudocode %}
  <!-- pseudocode -->
  <link
    defer
    rel="stylesheet"
    href="{{ site.third_party_libraries.pseudocode.url.css }}"
    integrity="{{ site.third_party_libraries.pseudocode.integrity.css }}"
    crossorigin="anonymous"
  >
{% endif %}

{%- comment -%} Favicons for light/dark mode {%- endcomment -%}
<!-- Baseline (system preference) -->
<link rel="icon" type="image/png"
      href="{{ '/assets/img/favicon-light.png' | relative_url | bust_file_cache }}"
      media="(prefers-color-scheme: light)">
<link rel="icon" type="image/png"
      href="{{ '/assets/img/favicon-dark.png'  | relative_url | bust_file_cache }}"
      media="(prefers-color-scheme: dark)">

<!-- JS-controlled favicon (always last so it wins) -->
<link id="dynamic-favicon" rel="icon" type="image/png"
      href="{{ '/assets/img/favicon-light.png' | relative_url | bust_file_cache }}">

<link rel="stylesheet" href="{{ '/assets/css/main.css' | relative_url | bust_css_cache }}">
<link rel="canonical" href="{{ page.url | replace:'index.html','' | absolute_url }}">

{% if site.enable_darkmode %}
  <!-- Dark Mode -->
  <script src="{{ '/assets/js/theme.js' | relative_url | bust_file_cache }}"></script>
  <link
    defer
    rel="stylesheet"
    href="{{ '/assets/css/jekyll-pygments-themes-native.css' | relative_url | bust_file_cache }}"
    media="none"
    id="highlight_theme_dark"
  >
  <script>
    initTheme();

    // Live favicon switcher (system + al-folio toggle)
    (function () {
      const LIGHT = "{{ '/assets/img/favicon-light.png' | relative_url | bust_file_cache }}";
      const DARK  = "{{ '/assets/img/favicon-dark.png'  | relative_url | bust_file_cache }}";

      function ensureLastIconLink() {
        const head = document.head || document.getElementsByTagName('head')[0];
        let link = document.querySelector('#dynamic-favicon');
        if (!link) {
          link = document.createElement('link');
          link.id = 'dynamic-favicon';
          link.rel = 'icon';
          link.type = 'image/png';
          head.appendChild(link);
        } else if (link.parentNode.lastElementChild !== link) {
          head.appendChild(link); // move to end so it wins
        }
        return link;
      }

      const mql = window.matchMedia('(prefers-color-scheme: dark)');

      function isDark() {
        const htmlTheme = document.documentElement.getAttribute('data-theme');
        if (htmlTheme === 'dark') return true;
        if (htmlTheme === 'light') return false;

        const bodyTheme = document.body && document.body.getAttribute('data-theme');
        if (bodyTheme === 'dark') return true;
        if (bodyTheme === 'light') return false;

        return mql.matches;
      }

      function setFavicon() {
        const link = ensureLastIconLink();
        const desired = isDark() ? DARK : LIGHT;
        const bust = (desired.indexOf('?') >= 0 ? '&' : '?') + 't=' + (Date.now() % 1e7);
        link.href = desired + bust;
      }

      // Initial run
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', setFavicon);
      } else {
        setFavicon();
      }

      // Watch for changes
      if (mql.addEventListener) mql.addEventListener('change', setFavicon);
      else mql.addListener(setFavicon);

      const mo = new MutationObserver(setFavicon);
      mo.observe(document.documentElement, { attributes: true, attributeFilter: ['data-theme'] });
      if (document.body) mo.observe(document.body, { attributes: true, attributeFilter: ['data-theme'] });

      window.addEventListener('themechange', setFavicon, { passive: true });
    })();
  </script>
{% endif %}

{% if page.map %}
  <!-- GeoJSON support via Leaflet -->
  <link
    defer
    rel="stylesheet"
    href="{{ site.third_party_libraries.leaflet.url.css }}"
    integrity="{{ site.third_party_libraries.leaflet.integrity.css }}"
    crossorigin="anonymous"
  >
{% endif %}

{% if page.code_diff %}
  <!-- diff2html -->
  <link
    defer
    rel="stylesheet"
    href="{{ site.third_party_libraries.highlightjs.url.css.light }}"
    integrity="{{ site.third_party_libraries.highlightjs.integrity.css.light }}"
    crossorigin="anonymous"
    media="screen and (prefers-color-scheme: light)"
  >
  <link
    defer
    rel="stylesheet"
    href="{{ site.third_party_libraries.highlightjs.url.css.dark }}"
    integrity="{{ site.third_party_libraries.highlightjs.integrity.css.dark }}"
    crossorigin="anonymous"
    media="screen and (prefers-color-scheme: dark)"
  >
  <link
    defer
    rel="stylesheet"
    href="{{ site.third_party_libraries.diff2html.url.css }}"
    integrity="{{ site.third_party_libraries.diff2html.integrity.css }}"
    crossorigin="anonymous"
  >
{% endif %}

{% if page.images %}
  {% if page.images.compare %}
    <link defer rel="stylesheet"
          href="{{ site.third_party_libraries.img-comparison-slider.url.css }}"
          integrity="{{ site.third_party_libraries.img-comparison-slider.integrity.css }}"
          crossorigin="anonymous">
  {% endif %}
  {% if page.images.lightbox2 %}
    <link defer rel="stylesheet"
          href="{{ site.third_party_libraries.lightbox2.url.css }}"
          integrity="{{ site.third_party_libraries.lightbox2.integrity.css }}"
          crossorigin="anonymous">
  {% endif %}
  {% if page.images.photoswipe %}
    <link defer rel="stylesheet"
          href="{{ site.third_party_libraries.photoswipe.url.css }}"
          crossorigin="anonymous">
  {% endif %}
  {% if page.images.slider %}
    <link defer rel="stylesheet"
          href="{{ site.third_party_libraries.swiper.url.css }}"
          integrity="{{ site.third_party_libraries.swiper.integrity.css }}"
          crossorigin="anonymous">
  {% endif %}
  {% if page.images.spotlight %}
    <link defer rel="stylesheet"
          href="{{ site.third_party_libraries.spotlight.url.css }}"
          integrity="{{ site.third_party_libraries.spotlight.integrity.css }}"
          crossorigin="anonymous">
  {% endif %}
  {% if page.images.venobox %}
    <link defer rel="stylesheet"
          href="{{ site.third_party_libraries.venobox.url.css }}"
          integrity="{{ site.third_party_libraries.venobox.integrity.css }}"
          crossorigin="anonymous">
  {% endif %}
{% endif %}

{% if page.tikzjax %}
  <link defer rel="stylesheet" type="text/css" href="https://tikzjax.com/v1/fonts.css">
{% endif %}
