<!-- Dynamic favicon for light/dark (robust) -->
<script>
(function () {
  // Update these if you move the files; bump ?v=3 to bust cache
  const LIGHT = "{{ '/assets/img/favicon-light.png?v=3' | relative_url }}";
  const DARK  = "{{ '/assets/img/favicon-dark.png?v=3'  | relative_url }}";

  const mql = window.matchMedia('(prefers-color-scheme: dark)');

  function themeIsDark() {
    // 1) explicit manual choice saved by al-folio
    const stored = localStorage.getItem('theme'); // 'dark' | 'light' | null
    if (stored === 'dark') return true;
    if (stored === 'light') return false;

    // 2) attribute/class the theme sets on <html>
    const el = document.documentElement;
    const attr = el.getAttribute('data-theme');
    if (attr === 'dark') return true;
    if (attr === 'light') return false;
    if (el.classList.contains('dark')) return true;
    if (el.classList.contains('light')) return false;

    // 3) fallback: system
    return mql.matches;
  }

  function removeExistingIcons() {
    document.querySelectorAll('link[rel*="icon"]').forEach(n => n.parentNode.removeChild(n));
  }

  function injectIcon(href) {
    const link = document.createElement('link');
    link.rel = 'icon';
    link.type = 'image/png';
    link.href = href;
    // put it LAST in <head> so it wins over anything the theme adds
    document.head.appendChild(link);

    // (Optional) also add a 'shortcut icon' for older browsers
    const shortcut = document.createElement('link');
    shortcut.rel = 'shortcut icon';
    shortcut.type = 'image/png';
    shortcut.href = href;
    document.head.appendChild(shortcut);
  }

  function applyFavicon() {
    removeExistingIcons();
    injectIcon(themeIsDark() ? DARK : LIGHT);
  }

  function init() {
    applyFavicon();

    // react to system scheme change
    mql.addEventListener?.('change', applyFavicon);

    // react to manual toggle (al-folio flips attributes / localStorage)
    new MutationObserver(applyFavicon)
      .observe(document.documentElement, { attributes: true, attributeFilter: ['data-theme','class'] });

    window.addEventListener('storage', e => { if (e.key === 'theme') applyFavicon(); });
  }

  // Run after DOM is ready so we can safely remove/append in <head>
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', init);
  } else {
    init();
  }
})();
</script>
